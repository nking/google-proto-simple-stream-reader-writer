<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
    "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <script type="text/javascript" src="/js/jquery-1.6.4.min.js"></script>
        <link rel="stylesheet" href="stylesheets/qunit.css" type="text/css" media="screen" />
        <script type="text/javascript" src="/js/qunit.js"></script>
        <script type="text/javascript" src="/js/protobuf.js"></script>
        <script type="text/javascript" src="/js/pbj.js"></script>
        <script type="text/javascript" src="/js/googleProtocolBufferMessagesReader.js"></script>
        <script type="text/javascript" src="/js/googleProtocolBufferMessagesAjaxHelper.js"></script>
        <script type="text/javascript" src="/js/examplemessage.proto.js"></script>

        <!-- from http://miskun.com/javascript/internet-explorer-and-binary-files-data-access/ -->
        <!--[if IE]>
            <script type="text/vbscript">
                Function IEBinaryToArray_ByteStr(Binary)
                    IEBinaryToArray_ByteStr = CStr(Binary)
                End Function
                Function IEBinaryToArray_ByteStr_Last(Binary)
                    Dim lastIndex
                    lastIndex = LenB(Binary)
                    if lastIndex mod 2 Then
                        IEBinaryToArray_ByteStr_Last = Chr( AscB( MidB( Binary, lastIndex, 1 ) ) )
                    Else
                        IEBinaryToArray_ByteStr_Last = ""
                    End If
                End Function
            </script>

        <![endif]-->

        <script>
            var gpburl = "http://127.0.0.1:8080/gpb"; /*match your LAN or desktop server IP address*/
            var retryCount = 0;
            var timeoutInMillis = 10000;

            function printComment(testNumber, comment) {
                writeToElement.innerHTML = writeToElement.innerHTML
                    + "<br/>(" + testNumber + "), "
                    + "<e style='color:grey;'>" + comment + "</e>";
            }
            function printPass(testNumber, testDesc) {
                writeToElement.innerHTML = writeToElement.innerHTML
                    + "<br/>(" + testNumber + "), "
                    + "<b style='color:green;'>passed</b> " + testDesc;
            }
            function printFail(testNumber, testDesc, msg) {
                writeToElement.innerHTML = writeToElement.innerHTML
                    + "<br/>(" + testNumber + "), "
                    + "<b style='color:red;'>failed</b> " + testDesc
                    + "<b style='color:red;'>; ERROR:" + msg + "</b>";
            }


            var createYourPROTOMessage = function() {
                return new com.climbwithyourfeet.proto.ExampleMsg;
            };

            var utf8Text = 'ct='+ window.encodeURIComponent('text/plain') + '&ec=' + window.encodeURIComponent('UTF-8');
            var utf7Text = 'ct='+ window.encodeURIComponent('text/plain') + '&ec=' + window.encodeURIComponent('UTF-7');
            var iso88591Text = 'ct='+ window.encodeURIComponent('text/plain') + '&ec=' + window.encodeURIComponent('ISO-8859-1');
            var utf8OctetStream = 'ct='+ window.encodeURIComponent('application/octet-stream') + '&ec=' + window.encodeURIComponent('UTF-8');

            $(document).ready(function() {

                var testNumber = 0;

                writeToElement.innerHTML = "<br/><b>[" + navigator.userAgent + "]</b>";

                /* functions to invoke requests with variations on the ajax method, the javascript data type,
                 * the server content type and server character encoding */

                function req3(testDesc, url, fnc) {
                    testNumber++;
                    expect( 1 );

                    var printCallback = function(msg) {
                        printComment(testNumber, msg);
                    }

                    var successCallback = function(messages) {
                        start();
                        var pass = (messages != undefined);
                        pass = pass && (messages.length > 0);
                        ok(pass, 'request and deserialization worked');
                        if (pass) {
                            printCallback('last message=' + messages[messages.length-1]);
                            printPass(testNumber, testDesc);
                        } else {
                            printFail(testNumber, testDesc, 'deserialized msg missing properties');
                        }
                    }
                    var errorCallback = function(msg) {
                        start();
                        ok(false, 'failed for request and parse');
                        printFail(testNumber, testDesc, msg);
                    }

                    var m = [];
                    var perMessageCallback = function renderEvent(gpbMessage, dictionary) {
                        m.push(gpbMessage);
                    };
                    var completedCallback = function deserializationIsDone(dictionary) {
                        printCallback('Completed.  passing ' + m.length + ' messages');
                        successCallback(m);
                    };
                    var errorHandle = function(errorString, dictionary) {
                        errorCallback(errorString);
                    };
                    var userdictionary = {'key': "key"};

                    try {
                        fnc(url, createYourPROTOMessage, perMessageCallback, completedCallback, errorHandle, userdictionary, timeoutInMillis);
                    } catch(e) {
                        errorCallback(e.message);
                    }
                }

                asyncTest("makeXMLHttpRequestForArrayBufferWithTypedArray (w/ delimiters)", function() {
                    req3('XMLHttpRequest + ArrayBuffer + TypedArray + (w/ delimiters) + utf8 + octet-stream',
                    gpburl + '?' + utf8OctetStream, makeXMLHttpRequestForArrayBufferWithTypedArray)});

                asyncTest("makeXMLHttpRequest (w/ delimiters)", function() {
                    req3('XMLHttpRequest + (w/ delimiters) + utf8 + octet-stream',
                    gpburl + '?' + utf8OctetStream, makeXMLHttpRequest)});

                asyncTest("makeXMLHttpRequestSync (no delimiters)", function() {
                    req3('XMLHttpRequest + synchronous +  (no delimiters) + utf8 + octet-stream',
                    gpburl + '?' + utf8OctetStream, makeSynchronousXMLHttpRequest)});

                /* works for ie9 */
                asyncTest("makeXDomainRequest (w/ delimiters)", function(){
                    req3('XDomainRequest + (w/ delimiters) + utf7 + text',
                    gpburl + '?' + utf7Text, makeXDomainRequest)});

                /* works for ie6-ie8 */
                asyncTest("makeActiveXObjectRequest (w/ delimiters)", function() {
                    req3('ActiveXObjectRequest + (w/ delimiters) + octet-stream + utf8',
                    gpburl + '?' + utf8OctetStream, makeBinaryActiveXObjectRequest)});
            });
        </script>
    </head>
    <body>
        <h1 id="qunit-header">QUnit test for Javascript Google Protocol Buffer libraries</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <div id="output"></div>
        <br/>

        <script type='text/javascript'>
            writeToElement = document.getElementById('output');
        </script>
    </body>
</html>
